<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>حمام القدس — إدارة 5 غرف</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111833;
      --muted:#93a4c7;
      --text:#e8eefc;
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#ef4444;
      --free:#22c55e;
      --border:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 500px at 30% 0%, rgba(45,212,191,.10), transparent 55%),
                  radial-gradient(900px 420px at 70% 0%, rgba(239,68,68,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      padding: 18px 18px 6px 18px;
      max-width: 1100px;
      margin: 0 auto;
    }
    h1{margin:0 0 6px 0; font-size: 22px; font-weight: 800;}
    .sub{color:var(--muted); font-size: 13px; line-height: 1.6;}
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 18px 24px 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(190px, 1fr));
      gap: 12px;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: repeat(3, minmax(190px, 1fr)); }
    }
    @media (max-width: 760px){
      .grid{ grid-template-columns: repeat(2, minmax(170px, 1fr)); }
    }
    @media (max-width: 420px){
      .grid{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      position: relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(450px 150px at 40% -10%, rgba(45,212,191,.12), transparent 60%),
                  radial-gradient(450px 160px at 70% 0%, rgba(147,164,199,.10), transparent 55%);
      pointer-events:none;
    }
    .card > *{ position:relative; }
    .row{display:flex; align-items:center; justify-content:space-between; gap:8px;}
    .room-title{font-weight:900; letter-spacing:.2px;}
    .badge{
      font-size:12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .badge.free{ color: #d1fae5; border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.10); }
    .badge.busy{ color: #cffafe; border-color: rgba(45,212,191,.35); background: rgba(45,212,191,.10); }
    .timer{
      margin-top: 10px;
      font-variant-numeric: tabular-nums;
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .5px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      text-align:center;
      direction:ltr; /* لضمان عرض HH:MM:SS بشكل صحيح */
    }
    .timer.normal{ color: var(--ok); }
    .timer.warn{ color: var(--warn); }
    .timer.over{ color: var(--bad); border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.08); }
    .meta{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.55;
    }
    .meta b{ color: var(--text); font-weight: 800; }
    .btns{ display:flex; gap:8px; margin-top: 12px; flex-wrap:wrap;}
    button{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 750;
      font-size: 13px;
      font-family: inherit;
    }
    button:hover{ background: rgba(255,255,255,.08); }
    button.primary{ border-color: rgba(45,212,191,.45); background: rgba(45,212,191,.12); }
    button.danger{ border-color: rgba(239,68,68,.45); background: rgba(239,68,68,.12); }
    button.ghost{ background: transparent; }
    .footer{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
    }
    .small{ color: var(--muted); font-size: 12px; }
    .kpis{ display:flex; gap: 10px; flex-wrap:wrap; }
    .kpi{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
    }

    dialog{
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #0f1733;
      color: var(--text);
      box-shadow: var(--shadow);
      width: min(520px, calc(100% - 22px));
    }
    dialog::backdrop{ background: rgba(0,0,0,.55); }
    .dlg-h{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 14px 14px 8px 14px;
      border-bottom: 1px solid var(--border);
    }
    .dlg-title{ font-weight: 900; }
    .dlg-b{ padding: 14px; }
    label{ display:block; color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    input[type="time"]{
      width: 100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-size: 14px;
      font-variant-numeric: tabular-nums;
      direction:ltr;
    }
    .hint{ color: var(--muted); font-size: 12px; margin-top: 8px; line-height:1.6; }
    .dlg-actions{ display:flex; gap:8px; justify-content:flex-start; margin-top: 12px; flex-wrap:wrap; }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--text);
      margin-top: 10px;
    }
    th, td{
      padding: 8px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    th{ color: var(--muted); text-align:right; font-weight:800; }
    .danger-text{ color: var(--bad); font-weight:900; }

    /* سطر حقوق النشر أسفل الصفحة */
    .copyright{
      margin-top: 12px;
      text-align:center;
      color: var(--muted);
      font-size: 12px;
      padding-bottom: 8px;
    }
  </style>
</head>

<body>
<header>
  <h1>حمام القدس</h1>
  <div class="sub">
    المدة القياسية: <b>ساعة واحدة</b>. قبل انتهاء الساعة: عدّ تنازلي. بعد الساعة: يظهر التجاوز باللون الأحمر (+وقت إضافي).
  </div>
</header>

<div class="wrap">
  <div id="grid" class="grid"></div>

  <div class="footer">
    <div class="kpis" id="kpis"></div>
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="ghost" id="btnHistory">السجل</button>
      <button class="ghost" id="btnExport">تصدير CSV</button>
      <button class="ghost" id="btnReset">إعادة ضبط</button>
    </div>
  </div>

  <div class="small" style="margin-top:10px;">
    الحفظ المحلي مُفعّل: حالة الغرف تبقى محفوظة في هذا المتصفح.
  </div>

  <div class="copyright">جميع الحقوق محفوظة</div>
</div>

<!-- Dialog: start -->
<dialog id="dlgStart">
  <div class="dlg-h">
    <div class="dlg-title" id="dlgStartTitle">بدء</div>
    <button class="ghost" id="dlgStartClose" aria-label="إغلاق">إغلاق</button>
  </div>
  <div class="dlg-b">
    <div class="hint">
      اختر طريقة البدء:
      <ul style="margin:8px 0 0 18px; padding:0; color: var(--muted);">
        <li><b>الآن</b>: يبدأ فورًا.</li>
        <li><b>وقت يدوي</b>: مفيد إذا نسيت تشغيل المؤقت عند البداية.</li>
      </ul>
    </div>

    <div style="margin-top:12px;">
      <label for="startTime">وقت يدوي (HH:MM)</label>
      <input id="startTime" type="time" step="60" />
      <div class="hint">إذا تركته فارغًا يمكنك اختيار “ابدأ الآن”.</div>
    </div>

    <div class="dlg-actions">
      <button id="btnStartNow" class="primary">ابدأ الآن</button>
      <button id="btnStartManual" class="primary">ابدأ بالوقت</button>
    </div>
  </div>
</dialog>

<!-- Dialog: history -->
<dialog id="dlgHistory">
  <div class="dlg-h">
    <div class="dlg-title">السجل</div>
    <button class="ghost" id="dlgHistoryClose" aria-label="إغلاق">إغلاق</button>
  </div>
  <div class="dlg-b">
    <div class="hint">سجل محلي (على هذا المتصفح). يمكنك التصدير إلى CSV.</div>
    <div id="historyContainer"></div>
  </div>
</dialog>

<script>
(() => {
  const ONE_HOUR_MS = 60 * 60 * 1000;

  const STORAGE_KEY = "bain_public_state_v1";
  const HISTORY_KEY = "bain_public_history_v1";

  /** State schema:
   * rooms: [{ id:1..5, status:"FREE"|"OCCUPIED", startMs:null|number }]
   */
  function defaultState(){
    return { rooms: Array.from({length:5}, (_,i)=>({ id:i+1, status:"FREE", startMs:null })) };
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      if(!parsed?.rooms || !Array.isArray(parsed.rooms) || parsed.rooms.length !== 5) return defaultState();
      return parsed;
    }catch(_){ return defaultState(); }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadHistory(){
    try{
      const raw = localStorage.getItem(HISTORY_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    }catch(_){ return []; }
  }

  function saveHistory(){
    localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
  }

  function addHistory(entry){
    history.unshift(entry);
    if(history.length > 500) history.pop();
    saveHistory();
  }

  function pad2(n){ return String(n).padStart(2,"0"); }

  function fmtHMS(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${pad2(hh)}:${pad2(mm)}:${pad2(ss)}`;
  }

  function fmtDateTime(ms){
    const d = new Date(ms);
    const yyyy = d.getFullYear();
    const MM = pad2(d.getMonth()+1);
    const dd = pad2(d.getDate());
    const hh = pad2(d.getHours());
    const mm = pad2(d.getMinutes());
    return `${yyyy}-${MM}-${dd} ${hh}:${mm}`;
  }

  function todayWithTime(timeHHMM){
    const [hh, mm] = timeHHMM.split(":").map(x => parseInt(x,10));
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    return d.getTime();
  }

  function computeRoomDisplay(room, nowMs){
    if(room.status === "FREE" || !room.startMs){
      return {
        badgeClass:"free",
        badgeText:"فارغة",
        timerText:"—",
        timerClass:"normal",
        meta:"لا يوجد استخدام حاليًا."
      };
    }

    const elapsed = nowMs - room.startMs;
    if(elapsed < ONE_HOUR_MS){
      const remaining = ONE_HOUR_MS - elapsed;
      const timerClass = remaining <= 10*60*1000 ? "warn" : "normal";
      return {
        badgeClass:"busy",
        badgeText:"مشغولة",
        timerText: fmtHMS(remaining),
        timerClass,
        meta: `البداية: <b>${fmtDateTime(room.startMs)}</b><br>المتبقي: <b>${fmtHMS(remaining)}</b>`
      };
    } else {
      const over = elapsed - ONE_HOUR_MS;
      return {
        badgeClass:"busy",
        badgeText:"مشغولة (تجاوز)",
        timerText: `+${fmtHMS(over)}`,
        timerClass:"over",
        meta: `البداية: <b>${fmtDateTime(room.startMs)}</b><br>تمت ساعة كاملة: <b>01:00:00</b><br>التجاوز: <b class="danger-text">+${fmtHMS(over)}</b>`
      };
    }
  }

  const grid = document.getElementById("grid");
  const kpis = document.getElementById("kpis");

  const dlgStart = document.getElementById("dlgStart");
  const dlgStartTitle = document.getElementById("dlgStartTitle");
  const startTimeInput = document.getElementById("startTime");
  const btnStartNow = document.getElementById("btnStartNow");
  const btnStartManual = document.getElementById("btnStartManual");
  const dlgStartClose = document.getElementById("dlgStartClose");

  const dlgHistory = document.getElementById("dlgHistory");
  const dlgHistoryClose = document.getElementById("dlgHistoryClose");
  const historyContainer = document.getElementById("historyContainer");

  const btnHistory = document.getElementById("btnHistory");
  const btnExport = document.getElementById("btnExport");
  const btnReset = document.getElementById("btnReset");

  let state = loadState();
  let history = loadHistory();

  let startTargetRoomId = null;

  function render(){
    const nowMs = Date.now();
    grid.innerHTML = "";

    let freeCount = 0, busyCount = 0, overCount = 0;

    for(const room of state.rooms){
      const disp = computeRoomDisplay(room, nowMs);

      if(room.status === "FREE") freeCount++;
      else {
        busyCount++;
        if(disp.timerClass === "over") overCount++;
      }

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="row">
          <div class="room-title">غرفة ${room.id}</div>
          <div class="badge ${disp.badgeClass}">${disp.badgeText}</div>
        </div>

        <div class="timer ${disp.timerClass}">${disp.timerText}</div>
        <div class="meta">${disp.meta}</div>

        <div class="btns">
          ${room.status === "FREE"
            ? `<button class="primary" data-action="start" data-room="${room.id}">بدء</button>`
            : `<button class="danger" data-action="end" data-room="${room.id}">تحرير</button>`
          }
          <button class="ghost" data-action="details" data-room="${room.id}">تفاصيل</button>
        </div>
      `;

      grid.appendChild(card);
    }

    kpis.innerHTML = `
      <div class="kpi">الغرف الفارغة: <b style="color:var(--text)">${freeCount}</b></div>
      <div class="kpi">الغرف المشغولة: <b style="color:var(--text)">${busyCount}</b></div>
      <div class="kpi">في حالة تجاوز: <b style="color:var(--text)">${overCount}</b></div>
      <div class="kpi">الوقت الآن: <b style="color:var(--text)">${new Date().toLocaleTimeString("ar-DZ")}</b></div>
    `;
  }

  function openStartDialog(roomId){
    startTargetRoomId = roomId;
    dlgStartTitle.textContent = `بدء — غرفة ${roomId}`;
    startTimeInput.value = "";
    dlgStart.showModal();
  }

  function startRoom(roomId, startMs){
    const room = state.rooms.find(r => r.id === roomId);
    if(!room) return;

    room.status = "OCCUPIED";
    room.startMs = startMs;

    saveState();
    render();
  }

  function endRoom(roomId){
    const room = state.rooms.find(r => r.id === roomId);
    if(!room || room.status !== "OCCUPIED" || !room.startMs) return;

    const endMs = Date.now();
    const elapsed = endMs - room.startMs;
    const over = Math.max(0, elapsed - ONE_HOUR_MS);

    addHistory({
      roomId,
      startMs: room.startMs,
      endMs,
      elapsedMs: elapsed,
      overMs: over
    });

    room.status = "FREE";
    room.startMs = null;

    saveState();
    render();
  }

  function showDetails(roomId){
    const room = state.rooms.find(r => r.id === roomId);
    if(!room) return;

    if(room.status === "FREE"){
      alert(`الغرفة ${roomId} فارغة.`);
      return;
    }
    const nowMs = Date.now();
    const elapsed = nowMs - room.startMs;
    const over = Math.max(0, elapsed - ONE_HOUR_MS);
    const remaining = Math.max(0, ONE_HOUR_MS - elapsed);

    const msg =
      `غرفة ${roomId} — مشغولة\n` +
      `البداية: ${fmtDateTime(room.startMs)}\n` +
      `الوقت المنقضي: ${fmtHMS(elapsed)}\n` +
      (elapsed < ONE_HOUR_MS
        ? `المتبقي (حتى ساعة): ${fmtHMS(remaining)}`
        : `التجاوز: +${fmtHMS(over)}`
      );

    alert(msg);
  }

  function renderHistoryDialog(){
    if(history.length === 0){
      historyContainer.innerHTML = `<div class="hint">لا توجد بيانات بعد.</div>`;
      return;
    }

    const rows = history.slice(0, 200).map(h => {
      const room = `غرفة ${h.roomId}`;
      const start = fmtDateTime(h.startMs);
      const end = fmtDateTime(h.endMs);
      const elapsed = fmtHMS(h.elapsedMs);
      const over = h.overMs > 0 ? `+${fmtHMS(h.overMs)}` : "—";
      const overClass = h.overMs > 0 ? "danger-text" : "";
      return `
        <tr>
          <td>${room}</td>
          <td style="direction:ltr">${start}</td>
          <td style="direction:ltr">${end}</td>
          <td style="direction:ltr">${elapsed}</td>
          <td class="${overClass}" style="direction:ltr">${over}</td>
        </tr>
      `;
    }).join("");

    historyContainer.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>الغرفة</th>
            <th>البداية</th>
            <th>النهاية</th>
            <th>المدة</th>
            <th>التجاوز</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="hint" style="margin-top:10px;">
        العرض محدود إلى 200 سطر (استعمل تصدير CSV للاحتفاظ بكل السجل).
      </div>
    `;
  }

  function exportCSV(){
    const headers = ["roomId","start","end","elapsed","over"];
    const lines = [headers.join(",")];

    for(const h of history.slice().reverse()){
      const start = fmtDateTime(h.startMs);
      const end = fmtDateTime(h.endMs);
      const elapsed = fmtHMS(h.elapsedMs);
      const over = h.overMs > 0 ? `+${fmtHMS(h.overMs)}` : "";
      const row = [
        h.roomId,
        `"${start}"`,
        `"${end}"`,
        `"${elapsed}"`,
        `"${over}"`
      ].join(",");
      lines.push(row);
    }

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `hamam_alquds_history_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll(){
    const ok = confirm("هل تريد إعادة ضبط كل الغرف ومسح السجل؟ هذا الإجراء لا يمكن التراجع عنه.");
    if(!ok) return;
    state = defaultState();
    history = [];
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(HISTORY_KEY);
    render();
  }

  grid.addEventListener("click", (e) => {
    const btn = e.target.closest("button");
    if(!btn) return;
    const action = btn.dataset.action;
    const roomId = parseInt(btn.dataset.room, 10);
    if(!action || !roomId) return;

    if(action === "start") openStartDialog(roomId);
    if(action === "end") endRoom(roomId);
    if(action === "details") showDetails(roomId);
  });

  dlgStartClose.addEventListener("click", () => dlgStart.close());

  btnStartNow.addEventListener("click", () => {
    if(!startTargetRoomId) return;
    startRoom(startTargetRoomId, Date.now());
    dlgStart.close();
  });

  btnStartManual.addEventListener("click", () => {
    if(!startTargetRoomId) return;
    const t = startTimeInput.value;
    if(!t){
      alert("الرجاء إدخال الوقت (HH:MM) أو اختر “ابدأ الآن”.");
      return;
    }
    const startMs = todayWithTime(t);
    const nowMs = Date.now();
    if(startMs > nowMs){
      alert("الوقت المُدخل في المستقبل. صحّح الوقت أو استخدم “ابدأ الآن”.");
      return;
    }
    startRoom(startTargetRoomId, startMs);
    dlgStart.close();
  });

  btnHistory.addEventListener("click", () => {
    renderHistoryDialog();
    dlgHistory.showModal();
  });
  dlgHistoryClose.addEventListener("click", () => dlgHistory.close());

  btnExport.addEventListener("click", () => exportCSV());
  btnReset.addEventListener("click", () => resetAll());

  render();
  setInterval(render, 1000);
})();
</script>
</body>
</html>
